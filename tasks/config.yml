---
- name: 'Create service and container folders'
  file:
    dest:  '{{ item }}'
    state: 'directory'
    owner: 'dockremap'
    group: 'docker'
    mode:  0775
  with_items:
    - '{{ postgres_ha_service_path }}'
    - '{{ postgres_ha_cont_data_vol }}'
    - '{{ postgres_ha_cont_init_vol }}'
    - '{{ postgres_ha_cont_backup_vol }}'

- name: Create dbinit SQL file to create DBs
  when: postgres_ha_is_master
  template:
    src:   'templates/init/databases.sql'
    dest:  '{{ postgres_ha_cont_init_vol }}/databases.sql'
    owner: '{{ postgres_ha_host_uid }}'
    group: 'dockremap'
    mode:  0640
  register: postgres_ha_init_db

- name: Create dbinit SQL file to alter system settings
  template:
    src:   'templates/init/alter_system.sql'
    dest:  '{{ postgres_ha_cont_init_vol }}/alter_system.sql'
    owner: '{{ postgres_ha_host_uid }}'
    group: 'dockremap'
    mode:  0640
  register: postgres_ha_init_system

- name: Install PostgreSQL client
  apt:
    name: 'postgresql-client'

- name: Create wrapper scripts
  template:
    src:   '{{ item }}'
    dest:  '{{ postgres_ha_service_path }}/{{ item | basename }}'
    owner: 'root'
    group: 'docker'
    mode:  0750
  with_fileglob:
    - 'templates/scripts/*.sh'

- name: 'Create compose file'
  template:
    src:   'docker-compose.yml.j2'
    dest:  '{{ postgres_ha_compose_file }}'
    owner: 'dockremap'
    group: 'docker'
    mode:  0644
